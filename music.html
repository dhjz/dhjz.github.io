<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>云音乐 - 在线音乐播放器</title>
  <link href="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    [v-cloak] { display: none; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; background: #0c0c0c; color: #fff; overflow-x: hidden; }
    .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: -2; }
    .bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(20px); z-index: -1; }
    @keyframes gradientBG { 0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .wrap-box { background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 20px; backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .navbar { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 15px 0; position: sticky; top: 0; z-index: 100; }
    .nav-container { max-width: 1400px; margin: 0 auto; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 12px; font-size: 24px; font-weight: bold; color: #fff; }
    .logo i { color: #ff6b6b; font-size: 28px; }
    .search-container { flex: 1; max-width: 600px; margin: 0 40px; position: relative; }
    .search-wrapper { display: flex; background: rgba(255, 255, 255, 0.15); border-radius: 25px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; }
    .search-input { flex: 1; padding: 12px 20px; background: transparent; border: none; color: #fff; font-size: 16px; outline: none; }
    .source-select { background: rgba(255, 255, 255, 0.1); border: none; color: #fff; padding: 12px 15px; outline: none; cursor: pointer; }
    .source-select option { background: #2a2a2a; color: #fff; padding: 8px; }
    .search-btn { background: #ff6b6b; border: none; color: #fff; padding: 12px 20px; cursor: pointer; transition: all 0.3s ease; }
    .search-btn:hover { background: #ff5252; }
    .main-container { max-width: 1600px; margin: 0 auto; padding: 30px; display: grid; grid-template-columns: 2.5fr 2fr 2fr; gap: 25px; min-height: calc(100vh - 200px); align-items: start; }
    .content-section { min-width: 0; overflow: hidden; min-height: 60vh; }
    .section-title { font-size: 20px; font-weight: 600; margin-bottom: 14px; color: #fff; display: flex; align-items: center; gap: 10px; }
    .section-title span { font-size: 14px; font-weight: 300; }
    .search-results { max-height: 670px; overflow-y: auto; }
    .song-item { display: flex; align-items: center; padding: 10px 10px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; margin-bottom: 8px; position: relative; overflow: hidden; }
    .song-item:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
    .song-item.active { background: linear-gradient(135deg, rgba(255, 107, 107, 0.3), rgba(255, 107, 107, 0.1)); border: 1px solid rgba(255, 107, 107, 0.5); }
    .song-index { width: 40px; height: 40px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 14px; font-weight: 600; color: rgba(255, 255, 255, 0.7); }
    .song-item.active .song-index { background: linear-gradient(135deg, #ff6b6b, #ff5252); color: #fff; }
    .song-info { flex: 1; width: 0; position: relative; }
    .song-info i { position: absolute; top: 2px; right: 2px;color: #ababab; display: none; }
    .song-info:hover i { display: block; }
    .song-name { font-weight: 600; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .song-artist { color: rgba(255, 255, 255, 0.7); font-size: .8em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .song-duration { color: rgba(255, 255, 255, 0.5); font-size: .8em; margin-left: 15px; display: none; }
    .player-section { xposition: sticky; top: 120px; height: fit-content; min-height: calc(100vh - 240px); display: flex; flex-direction: column; justify-content: space-between; }
    .current-song { text-align: center; margin-bottom: 25px; }
    .current-cover-container { position: relative; display: inline-block; margin-bottom: 20px; }
    .current-cover { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); transition: all 0.3s ease; border: 6px solid rgba(255, 255, 255, 0.1); position: relative; }
    .current-cover.playing { animation: rotate 20s linear infinite; }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); }  }
    .current-info h3 { font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #fff; }
    .current-info p { color: rgba(255, 255, 255, 0.7); font-size: 16px; }
    .player-controls { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 25px; }
    .control-btn { background: rgba(255, 255, 255, 0.1); border: none; border-radius: 50%; color: #fff; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    .control-btn:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
    .control-btn.small { width: 45px; height: 45px; font-size: 18px; }
    .play-btn { width: 65px; height: 65px; font-size: 28px; background: linear-gradient(135deg, #ff6b6b, #ff5252); box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); }
    .play-btn:hover { background: linear-gradient(135deg, #ff5252, #ff4444); box-shadow: 0 12px 35px rgba(255, 107, 107, 0.6); }
    .progress-container { margin-bottom: 20px; }
    .progress-bar { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.2); border-radius: 3px; cursor: pointer; margin-bottom: 10px; position: relative; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #ff6b6b, #ff8a80); border-radius: 3px; width: 0%; transition: width 0.1s ease; position: relative; }
    .progress-fill::after { content: ''; position: absolute; right: -2px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: #fff; border-radius: 50%; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
    .time-info { display: flex; justify-content: space-between; font-size: 13px; color: rgba(255, 255, 255, 0.7); }
    .volume-container { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; }
    .volume-icon { color: rgba(255, 255, 255, 0.7); font-size: 18px; }
    .volume-slider { flex: 1; height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; outline: none; cursor: pointer; -webkit-appearance: none; }
    .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #ff6b6b; border-radius: 50%; cursor: pointer; }
    .quality-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 12px 15px; background: rgba(255, 255, 255, 0.05); border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); }
    .quality-label { display: flex; align-items: center; gap: 8px; color: rgba(255, 255, 255, 0.8); font-size: 14px; }
    .quality-select { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #fff; padding: 8px 12px; outline: none; cursor: pointer; font-size: 14px; }
    .quality-select option { background: #2a2a2a; color: #fff; padding: 8px; }
    .download-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .download-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: #fff; cursor: pointer; transition: all 0.3s ease; font-size: 14px; }
    .download-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.2); border-color: #ff6b6b; color: #ff6b6b; }
    .download-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .song-actions { display: flex; gap: 8px; margin-right: 15px; }
    .action-btn { width: 32px; height: 32px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: none; color: rgba(255, 255, 255, 0.7); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .action-btn:hover { background: rgba(255, 107, 107, 0.3); color: #ff6b6b; transform: scale(1.1); }
    .list-section { height: 40vh; overflow: auto; margin-bottom: 10px; }
    .lyrics-section { height: 40vh; overflow: hidden; display: flex; flex-direction: column; }
    .lyrics-container { flex: 1; overflow-y: auto; padding-right: 10px; }
    .lyric-line, .lyric-empty { padding: 8px 0; transition: all 0.3s ease; border-radius: 6px; padding-left: 10px; margin-bottom: 4px; color: rgba(255, 255, 255, 0.6); line-height: 1.6; }
    .lyric-line:hover { background: rgba(255, 255, 255, 0.05); color: rgba(255, 255, 255, 0.8); }
    .lyric-line.active { color: #ff6b6b; font-weight: 600; background: rgba(255, 107, 107, 0.1); transform: scale(1.02); border-left: 3px solid #ff6b6b; }
    .loading, .error, .empty-state { text-align: center; padding: 30px 20px; color: rgba(255, 255, 255, 0.7); }
    .loading i, .error i, .empty-state i { font-size: 48px; margin-bottom: 15px; display: block; }
    .loading i { animation: spin 1s linear infinite; color: #ff6b6b; width: 50px;  margin: 10px auto; }
    .list-section .song-item { padding: 4px 8px; font-size: 14px; border-bottom: 1px solid rgba(153, 153, 153, 0.3); }
    @keyframes spin { from { transform: rotate(0deg); }  to { transform: rotate(360deg); } }
    .error i { color: #ff5252; }
    .empty-state i { color: rgba(255, 255, 255, 0.4); }
    @media (max-width: 768px) { 
      .wrap-box { padding: 14px 8px; }
      .nav-container { flex-direction: column; gap: 15px; padding: 0 10px; }
      .main-container { padding: 10px; grid-template-columns: 1fr; gap: 14px; }
      .search-container { margin: 0; max-width: none; width: 100%; }
      .content-section {  min-height: 40vh;  }
      .current-cover { width: 120px; height: 120px; }
      .player-controls { gap: 15px; }
      .search-input { padding: 12px 8px 12px 12px; font-size: 13px; }
      .search-btn { padding: 12px 8px; font-size: 13px; }
      .search-results { max-height: 60vh; }
      .source-select { padding: 12px 3px;  font-size: 13px; }
      .song-item { padding: 6px 8px; }
      .song-name { font-size: 14px; font-weight: normal; }
      .song-duration { display: none; }
      .action-btn { width: 26px; height: 26px; }
      .list-section, .lyrics-section { height: 60vh; }
    }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 8px; }
  </style>
</head>
<body>
  <div id="app" v-cloak>
    <div class="bg-animation"></div>
    <div class="bg-overlay"></div>
    <!-- 顶部导航 -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="logo"><i class="fas fa-music"></i><span>云音乐</span></div>
        <div class="search-container">
          <div class="search-wrapper">
            <input type="text" class="search-input" placeholder="搜索音乐、歌手、专辑..." v-model="searchKeyword" @keyup.enter="searchMusic" >
            <select class="source-select" v-model="selectedSource" >
              <option value="netease">网易云音乐</option>
              <option value="tencent">QQ音乐</option>
              <option value="kuwo">酷我音乐</option>
              <option value="joox">JOOX</option>
              <option value="kugou">酷狗音乐</option>
              <option value="migu">咪咕音乐</option>
              <option value="deezer">Deezer</option>
              <option value="spotify">Spotify</option>
              <option value="apple">Apple Music</option>
              <option value="ytmusic">YouTube Music</option>
              <option value="tidal">TIDAL</option>
              <option value="qobuz">Qobuz</option>
              <option value="ximalaya">喜马拉雅</option>
            </select>
            <button class="search-btn" @click="searchMusic"><i class="fas fa-search"></i></button>
          </div>
        </div>
      </div>
    </nav>
    <!-- 主要内容 -->
    <div class="main-container">
      <!-- 搜索结果区域 -->
      <div class="content-section wrap-box">
        <h2 class="section-title"><i class="fas fa-list-music"></i>搜索结果 </h2>
        <div class="search-results" id="searchResults">
          <div class="empty-state" v-if="!searchResults.length && !loading">
            <i class="fas fa-search"></i>
            <div>在上方搜索框输入关键词开始搜索音乐</div>
          </div>
          <div class="loading" v-show="loading">
              <i class="fas fa-spinner"></i>
              <div>正在搜索音乐...</div>
          </div>
          <div 
            v-for="(song, index) in searchResults" 
            :key="index" 
            class="song-item"
            :class="{ active: currentIndSh === index }"
            @click="playSong(index, true)"
          >
            <div class="song-index">{{ (index + 1).toString().padStart(2, '0') }}</div>
            <div class="song-info">
              <div class="song-name">{{ song.name }}</div>
              <div class="song-artist">
                {{ Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist }} · {{ song.album }}
              </div>
            </div>
            <div class="song-actions">
              <button class="action-btn" @click.stop="downloadSong(index, true)" title="下载音乐">
                <i class="fas fa-download"></i>
              </button>
              <button class="action-btn" @click.stop="downloadLyric(index, true)" title="下载歌词">
                <i class="fas fa-file-text"></i>
              </button>
            </div>
            <div class="song-duration">--:--</div>
          </div>
        </div>
      </div>
      <!-- 播放器区域 -->
      <div class="player-section wrap-box">
        <div class="current-song">
          <div class="current-cover-container">
            <img class="current-cover" :src="currentSong.cover || albumSbgImg" :class="{ playing: isPlaying}" alt="专辑封面" >
          </div>
          <div class="current-info">
            <h3>{{ currentSong.title || '未选择歌曲' }}</h3>
            <p>{{ currentSong.artist || '请搜索并选择要播放的歌曲' }}</p>
          </div>
        </div>

        <div class="player-controls">
          <button class="control-btn small" @click="previousSong">
            <i class="fas fa-step-backward"></i>
          </button>
          <button class="control-btn play-btn" @click="togglePlay">
            <i :class="isPlaying ? 'fas fa-pause' : 'fas fa-play'"></i>
          </button>
          <button class="control-btn small" @click="nextSong">
            <i class="fas fa-step-forward"></i>
          </button>
        </div>
        <div class="progress-container">
          <div class="progress-bar" @click="seekTo($event)">
            <div class="progress-fill" :style="{ width: progress + '%' }"></div>
          </div>
          <div class="time-info">
            <span>{{ formatTime(currentTime) }}</span>
            <span>{{ formatTime(totalTime) }}</span>
          </div>
        </div>
        <!-- 音质选择 -->
        <div class="quality-container">
          <div class="quality-label"><i class="fas fa-music"></i><span>音质</span></div>
          <select class="quality-select" v-model="selectedQuality" @change="changeQuality" >
            <option value="128">标准 128K</option>
            <option value="192">较高 192K</option>
            <option value="320" selected>高品质 320K</option>
            <option value="740">无损 FLAC</option>
            <option value="999">Hi-Res</option>
          </select>
        </div>
        <div class="volume-container">
          <i :class="volumeIconClass"></i>
          <input type="range" class="volume-slider" min="0" max="100" v-model="volume" @input="setVolume(volume)" >
        </div>
        <!-- 下载区域 -->
        <div class="download-container">
          <button class="download-btn" @click="downloadCurrentSong" :disabled="currentInd===-1" >
            <i class="fas fa-download"></i><span>下载音乐</span>
          </button>
          <button class="download-btn" @click="downloadCurrentLyric" :disabled="currentInd===-1" >
            <i class="fas fa-file-text"></i><span>下载歌词</span>
          </button>
        </div>
        <audio 
          ref="audioPlayer" 
          preload="metadata"
          @timeupdate="updateProgress"
          @loadedmetadata="updateTotalTime"
          @ended="nextSong"
          @play="isPlaying = true"
          @pause="isPlaying = false"
        ></audio>
      </div>
      <!-- 歌词区域 -->
      <div>
        <div class="list-section wrap-box">
          <h2 class="section-title">
            <i class="fas fa-align-left"></i>播放列表
            <span v-if="playList.length"> [ 共 {{ playList.length }} 条 ]</span>
          </h2>
          <div class="list-container" ref="listContainer">
            <div class="lyric-empty" v-if="!playList.length">请先添加歌曲</div>
            <div 
              v-for="(song, index) in playList" 
              :key="index" 
              class="song-item"
              :class="{ active: currentInd === index }"
              @click="playSong(index)"
            >
              <div class="song-info">
                <div class="song-name">{{ song.name }}</div>
                <div class="song-artist">
                  {{ Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist }} · {{ song.album }}
                </div>
                <i class="fas fa-minus-circle" @click.stop="delPlayList(index)"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="lyrics-section wrap-box">
          <h2 class="section-title">
            <i class="fas fa-align-left"></i>歌词
            <span v-if="lyricsEnd">[ end: {{ formatTime(lyricsEnd) }} ]</span>
          </h2>
          <div class="lyrics-container" ref="lyricsContainer">
            <div class="lyric-empty" v-if="!lyrics.length">暂无歌词</div>
            <div 
              v-for="(lyric, index) in lyrics" 
              :key="index"
              class="lyric-line"
              :class="{ active: currentLyricIndex === index }"
            >
              <!-- @click="seekToLyric(lyric.time)" -->
              {{ lyric.text }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/vue/3.5.17/vue.global.prod.js"></script>
  <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://mirrors.sustech.edu.cn/cdnjs/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script>
    const API_BASE = 'https://music-api.gdstudio.xyz/api.php';
    const svgString = `<svg width="220" height="220" viewBox="0 0 220 220" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="220" height="220" fill="rgba(255,255,255,0.1)" rx="20"/>
      <path d="M110 70L140 110H120V150H90V110H70L110 70Z" fill="rgba(255,255,255,0.3)"/>
      </svg>`;
    const albumSbgImg = `data:image/svg+xml;base64,${btoa(svgString)}`;

    var vueApp = Vue.createApp({
      data() {
        return {
          loading: false,
          searchKeyword: '',
          selectedSource: 'netease',
          selectedQuality: '320',
          searchResults: [],
          searchHistory: {},
          lyricHistory: {},
          // currentInd: -1,
          // currentIndSh: -1,
          playList: [],
          currentSong: {
            title: '',
            artist: '',
            cover: ''
          },
          isPlaying: false,
          currentTime: 0,
          totalTime: 0,
          progress: 0,
          volume: 80,
          lyrics: [],
          currentLyricIndex: -1,
          lyricsEnd: null,
          albumSbgImg
        };
      },
      computed: {
        volumeIconClass() {
          if (this.volume == 0) return 'fas fa-volume-mute volume-icon';
          if (this.volume < 50) return 'fas fa-volume-down volume-icon';
          return 'fas fa-volume-up volume-icon';
        },
        currentIndSh() {
          return this.searchResults.length ? this.searchResults.findIndex(x => `${x.source}_${x.id}` === this.currentSong.key) : -1;
        },
        currentInd() {
          return this.playList.length ? this.playList.findIndex(x => `${x.source}_${x.id}` === this.currentSong.key) : -1;
        },
      },
      async created() {
        this.searchHistory = await getStorage('searchHistory') || {}
        this.lyricHistory = await getStorage('lyricHistory') || {};
        this.playList = await getStorage('playList') || [];
      },
      methods: {
        async searchMusic() {
          if (!this.searchKeyword.trim()) {
            this.showNotification('请输入搜索关键词', 'warning');
            return;
          }
          const key = `${this.selectedSource}_${this.searchKeyword}`;
          if (this.searchHistory[key]) {
            this.searchResults = this.searchHistory[key];
            return
          }
          this.loading = true;
          try {
            const response = await fetch(`${API_BASE}?types=search&source=${this.selectedSource}&name=${encodeURIComponent(this.searchKeyword)}&count=30`);
            const data = await response.json();
            this.searchResults = data || [];
            if (!this.searchResults.length) {
              return this.showNotification('未找到相关歌曲，请尝试其他关键词', 'warning');
            }
            this.searchHistory[key] = this.searchResults;
            setStorage('searchHistory', this.searchHistory);
          } catch (error) {
            this.showNotification('网络连接失败，请检查网络后重试', 'error');
          } finally {
            this.loading = false;
          }
        },
        async playSong(ind, isSearch) {
          if (ind < 0 || (isSearch && ind >= this.searchResults.length)
            || (!isSearch && ind >= this.playList.length)) return;
          // this.currentIndSh = this.currentInd = -1;
          // isSearch ? (this.currentIndSh = ind) : (this.currentInd = ind);
          const song = isSearch ? this.searchResults[ind] : this.playList[ind];
          let key = `${song.source}_${song.id}`
          if (this.currentSong.key === key) return;
          // 更新当前歌曲信息
          this.currentSong = {
            key,
            id: song.id,
            source: song.source,
            title: song.name,
            artist: `${Array.isArray(song.artist) ? song.artist.join(' / ') : song.artist} · ${song.album}`,
            cover: await this.getAlbumCoverUrl(song)
          };
          // 加载歌词
          this.loadLyrics(song);
          try {
            this.showNotification('正在加载音乐...', 'info');
            let songUrl = getStorageExp(key)
            let br = null
            if (!songUrl) {
              // 获取音乐URL
              const response = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${this.selectedQuality}`);
              const data = await response.json();
              songUrl = data?.url;
              br = data?.br;
              songUrl && setStorageExp(key, songUrl, 2 * 60 * 60); // 缓存2小时
            } else {
              console.log('获取缓存音乐URL成功', song, songUrl);
            }
            if (!songUrl) {
              return this.showNotification('无法获取音乐链接，请尝试其他歌曲或更换音质', 'error');
            }

            this.addPlayList(song);
            
            this.$refs.audioPlayer.src = songUrl;
            this.$refs.audioPlayer.load();
            // 自动播放
            this.$refs.audioPlayer.play().then(() => {
              this.showNotification(`开始播放 ${song.artist} - ${song.name}`, 'success');
            }).catch((e) => {
              console.error('play error', e);
              this.showNotification('播放失败，请尝试其他歌曲', 'error');
            });
          } catch (error) {
            this.showNotification('播放失败，请检查网络连接', 'error');
          }
        },
        async getAlbumCoverUrl(song, size = 300) {
          if (!song.pic_id) return this.albumSbgImg;
          try {
            const response = await fetch(`${API_BASE}?types=pic&source=${song.source}&id=${song.pic_id}&size=${size}`);
            const data = await response.json();
            return data?.url || this.albumSbgImg;
          } catch (error) {
            return this.albumSbgImg;
          }
        },
        getQualityText(br) {
          const qualityMap = {
            '128': '标准音质',
            '192': '较高音质',
            '320': '高品质',
            '740': '无损音质',
            '999': 'Hi-Res音质'
          };
          return qualityMap[br] || `${br}K`;
        },
        addPlayList(song) {
          if (this.playList.some(x => x.id === song.id)) return
          this.playList.push(song);
          setStorage('playList', this.playList);
        },
        delPlayList(index) {
          if (!confirm('确定要删除此歌曲吗？')) return
          this.playList.splice(index, 1);
          setStorage('playList', this.playList);
        },
        togglePlay() {
          if (this.$refs.audioPlayer.src) {
            if (this.isPlaying) {
              this.$refs.audioPlayer.pause();
            } else {
              this.$refs.audioPlayer.play();
            }
          } else {
            this.showNotification('请先选择要播放的歌曲', 'warning');
          }
        },
        previousSong() {
          if (this.currentInd > 0) {
            this.playSong(this.currentInd - 1);
          } else {
            this.playSong(this.playList.length - 1);
            // this.showNotification('已经是第一首歌曲', 'info');
          }
        },
        nextSong() {
          if (this.currentInd < this.playList.length - 1) {
            this.playSong(this.currentInd + 1);
          } else {
            this.playSong(0);
            // this.showNotification('已经是最后一首歌曲', 'info');
          }
        },
        seekTo(event) {
          if (this.$refs.audioPlayer.duration) {
            const rect = event.target.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            this.$refs.audioPlayer.currentTime = percent * this.$refs.audioPlayer.duration;
          }
        },
        seekToLyric(time) {
          this.$refs.audioPlayer.currentTime = time;
        },
        setVolume(value) {
          this.$refs.audioPlayer.volume = value / 100;
        },
        updateProgress() {
          if (this.$refs.audioPlayer.duration) {
            this.progress = (this.$refs.audioPlayer.currentTime / this.$refs.audioPlayer.duration) * 100;
            this.currentTime = this.$refs.audioPlayer.currentTime;
            this.updateLyricHighlight();
          }
        },
        updateTotalTime() {
          this.totalTime = this.$refs.audioPlayer.duration;
        },
        changeQuality() {
          if (this.currentInd !== -1 && this.$refs.audioPlayer.src) {
            const currentTime = this.$refs.audioPlayer.currentTime;
            const wasPlaying = this.isPlaying;
            
            this.playSong(this.currentInd).then(() => {
              this.$refs.audioPlayer.currentTime = currentTime;
              if (!wasPlaying) {
                this.$refs.audioPlayer.pause();
              }
            });
          }
        },
        async loadLyrics(song) {
          this.lyrics = [];
          this.currentLyricIndex = -1;
          this.lyricsEnd = null;
          const key = `${song.source}_${song.id}`;
          if (this.lyricHistory[key]) {
            return this.parseLyrics(this.lyricHistory[key]);
          }
          
          try {
            const response = await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`);
            const data = await response.json();
            if (data?.lyric) {
              this.lyricHistory[key] = data.lyric;
              setStorage('lyricHistory', this.lyricHistory)
              this.parseLyrics(data.lyric);
            }
          } catch (error) {
            console.error('获取歌词失败:', error);
          }
        },
        parseLyrics(lrcText) {
          const lines = lrcText.split('\n');
          this.lyrics = [];
          
          lines.forEach(line => {
            const match = line.match(/\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/);
            if (match) {
              const minutes = parseInt(match[1]);
              const seconds = parseInt(match[2]);
              const milliseconds = parseInt(match[3].padEnd(3, '0'));
              const text = match[4].trim();
              
              if (text) {
                const time = minutes * 60 + seconds + milliseconds / 1000;
                this.lyrics.push({ time, text });
              }
            }
          });
          
          this.lyrics.sort((a, b) => a.time - b.time);
          if (this.lyrics.length) {
            this.lyricsEnd = this.lyrics[this.lyrics.length - 1].time;
          }
        },
        updateLyricHighlight() {
          const currentTime = this.$refs.audioPlayer.currentTime;
          let activeIndex = -1;
          
          for (let i = 0; i < this.lyrics.length; i++) {
            if (this.lyrics[i].time <= currentTime) {
              activeIndex = i;
            } else {
              break;
            }
          }
          
          this.currentLyricIndex = activeIndex;
          // 自动滚动到当前歌词
          if (activeIndex >= 0 && this.$refs.lyricsContainer) {
            const container = this.$refs.lyricsContainer;
            const activeLine = container.children[activeIndex];
            if (activeLine) {
              const containerHeight = container.clientHeight;
              const lineHeight = activeLine.offsetHeight;
              const lineOffsetTop = activeLine.offsetTop;
              const idealScrollTop = lineOffsetTop - (containerHeight / 2) + (lineHeight / 2);
              const scrollThreshold = containerHeight * 0.3;
              
              if (Math.abs(idealScrollTop - container.scrollTop) > scrollThreshold) {
                container.scrollTo({
                  top: Math.max(0, idealScrollTop),
                  behavior: 'smooth'
                });
              }
            }
          }
        },
        async downloadSong(ind, isSearch) {
          const song = isSearch ? this.searchResults[ind] : this.playList[ind];
          try {
            this.showNotification('正在获取下载链接...', 'info');
            
            const response = await fetch(`${API_BASE}?types=url&source=${song.source}&id=${song.id}&br=${this.selectedQuality}`);
            const data = await response.json();
            
            if (data?.url) {
              const link = document.createElement('a');
              link.href = data.url;
              link.download = `${song.name} - ${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist}.mp3`;
              link.target = '_blank';
              
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              this.showNotification('开始下载音乐文件', 'success');
            } else {
              this.showNotification('无法获取下载链接', 'error');
            }
          } catch (error) {
            this.showNotification('下载失败，请稍后重试', 'error');
          }
        },
        async downloadLyric(ind, isSearch) {
          const song = isSearch ? this.searchResults[ind] : this.playList[ind];
          
          try {
            this.showNotification('正在获取歌词...', 'info');

            const key = `${song.source}_${song.id}`;
            let lyricContent
            if (this.lyricHistory[key]) {
              lyricContent = this.lyricHistory[key];
            } else {
              const response = await fetch(`${API_BASE}?types=lyric&source=${song.source}&id=${song.lyric_id || song.id}`);
              const data = await response.json();
              lyricContent = data?.lyric;
            }
            if (!lyricContent) {
              this.showNotification('无法获取歌词', 'error');
              return;
            }

            downloadText(lyricContent, `${Array.isArray(song.artist) ? song.artist.join(', ') : song.artist} - ${song.name}.lrc`)
            this.showNotification('歌词下载完成', 'success');

          } catch (error) {
            this.showNotification('下载歌词失败，请稍后重试', 'error');
          }
        },
        downloadCurrentSong() {
          if (this.currentInd === -1) {
            this.showNotification('请先选择要下载的歌曲', 'warning');
            return;
          }
          this.downloadSong(this.currentInd);
        },
        downloadCurrentLyric() {
          if (this.currentInd === -1) {
            this.showNotification('请先选择要下载歌词的歌曲', 'warning');
            return;
          }
          this.downloadLyric(this.currentInd);
        },
        formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins}:${secs.toString().padStart(2, '0')}`;
        },
        showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 30px;
            background: ${type === 'success' ? 'rgba(76, 175, 80, 0.9)' :
                      type === 'error' ? 'rgba(244, 67, 54, 0.9)' :
                      type === 'warning' ? 'rgba(255, 152, 0, 0.9)' :
                      'rgba(33, 150, 243, 0.9)'};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
            font-size: 14px;
          `;
          notification.textContent = message;
          document.body.appendChild(notification);
          setTimeout(() => {
            notification.style.transform = 'translateX(0)';
          }, 100);
          setTimeout(() => {
            notification.style.transform = 'translateX(400px)';
            setTimeout(() => {
              document.body.removeChild(notification);
            }, 300);
          }, 3000);
        },
        handleKeyDown(e) {
          if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            this.togglePlay();
          } else if (e.code === 'ArrowLeft' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            this.previousSong();
          } else if (e.code === 'ArrowRight' && e.target.tagName !== 'INPUT') {
            e.preventDefault();
            this.nextSong();
          }
        }
      },
      mounted() {
        // 设置初始音量
        this.setVolume(this.volume);
        // 添加键盘事件监听
        document.addEventListener('keydown', this.handleKeyDown);
        // 显示欢迎信息
        setTimeout(() => {
          this.showNotification('欢迎使用云音乐播放器！', 'success');
        }, 1000);
      },
      beforeUnmount() {
        // 移除键盘事件监听
        document.removeEventListener('keydown', this.handleKeyDown);
      }
    }).mount('#app');

    localforage.config({ driver: localforage.INDEXEDDB, name: 'gdmusic-db', storeName: 'gdmusic-store' });
    async function getStorage(key) {
      const data = await localforage.getItem(key)
      let text = null
      if (data) {
        try {
          text = pako.inflate(data, { to: 'string' });
          return JSON.parse(text)
        } catch (error) {
          console.log('parse error', error);
          return text
        }
      }
      return text
    }
    function setStorage(key, val) {
      if (!val && val !== 0) return localforage.removeItem(key)
      let text = JSON.stringify(val)
      const data = pako.deflate(new TextEncoder().encode(text), { level: 9 });
      localforage.setItem(key, data).then(() => {
        const size = data.length / 1024;
        const size1 = new TextEncoder().encode(text).length / 1024; // 转换为KB
        console.log(`存储成功: ${data.length} 长度, ${size1.toFixed(2)}kb -> ${size.toFixed(2)}kb,  压缩率: ${(100 * size / size1).toFixed(2)}%`);
      }).catch(console.error);
    }

    function setStorageExp (key, val, ttl) {
      localStorage.setItem(key, JSON.stringify({ val, exp: Date.now() + ttl * 1000 }));
    }

    function getStorageExp (key) {
      const itemStr = localStorage.getItem(key);
      if (!itemStr) return null;
      const item = JSON.parse(itemStr);
      return Date.now() < item.expiry ? item.val : localStorage.removeItem(key);
    }

    function downloadText(text, name) {
      const url = URL.createObjectURL(new Blob([text], { type: 'text/plain;charset=utf-8' }));
      const link = Object.assign(document.createElement('a'), { href: url, download: name });
      document.body.appendChild(link).click();
      link.remove();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
